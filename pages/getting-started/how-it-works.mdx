import { Callout } from 'nextra/components'

# How Convultra Works

Convultra uses a multi-layered approach to achieve 95-98% conversion tracking accuracy. This page explains the data flow and key concepts.

## Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Your Website                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Convultra SDK (ultra.js)                                        │   │
│  │  • Captures click IDs (gclid, fbclid, msclkid)                  │   │
│  │  • Stores in localStorage (90-day retention)                     │   │
│  │  • Tracks sessions and page views                                │   │
│  │  • Sends conversions to Convultra                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         Convultra Platform                              │
│                                                                          │
│  • Receives and validates conversion events                             │
│  • Deduplicates across all sources                                      │
│  • Enriches with stored click history                                   │
│  • Forwards to connected ad platforms                                   │
│  • Powers real-time analytics dashboard                                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Ad Platforms                                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │ Google Ads  │ │  Meta Ads   │ │ Microsoft   │ │  TikTok     │       │
│  │ Offline API │ │ CAPI        │ │ Offline API │ │ Events API  │       │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: Capture

When a user lands on your website, the SDK immediately captures:

### Click IDs
```javascript
// Automatically captured from URL parameters
{
  gclid: 'Cj0KCQjw...',     // Google Ads
  fbclid: 'IwAR3x...',       // Meta/Facebook Ads
  msclkid: 'abc123...',      // Microsoft Ads
  ttclid: 'xyz789...',       // TikTok Ads
  twclid: '...',             // Twitter Ads
  li_fat_id: '...'           // LinkedIn Ads
}
```

### UTM Parameters
```javascript
{
  utm_source: 'google',
  utm_medium: 'cpc',
  utm_campaign: 'summer-sale',
  utm_term: 'best widgets',
  utm_content: 'ad-variant-a'
}
```

### Session Data
```javascript
{
  session_id: 'ses_1234567890_abc',
  landing_page: 'https://yoursite.com/?gclid=...',
  referrer: 'https://google.com/search?q=...',
  start_time: 1704067200000
}
```

---

## Phase 2: Store

All captured data is stored in **localStorage** with 90-day retention:

```javascript
// Click history - stores all paid clicks with full context
cvl_click_history: [
  {
    id: 'clk_1704067200000_abc123',
    key: 'gclid',
    platform: 'google_ads',
    click_id: 'Cj0KCQjw...',
    captured_at: '2024-01-01T12:00:00Z',
    landing_page: 'https://yoursite.com/pricing',
    utm_source: 'google',
    utm_campaign: 'summer-sale'
  }
]

// Session data - current user session
cvl_session: {
  id: 'ses_1704067200000_xyz',
  startTime: 1704067200000,
  pageViews: 5,
  gclid: 'Cj0KCQjw...',
  landingPage: 'https://yoursite.com/pricing'
}
```

<Callout type="info">
  **Why localStorage?**
  
  Unlike cookies which are limited to 7 days on iOS Safari, localStorage persists for 90+ days. This means we can attribute conversions even when users return weeks after clicking an ad.
</Callout>

---

## Phase 3: Forward

When a conversion occurs, the SDK sends the event to Convultra with all relevant attribution data:

```javascript
// What gets sent on conversion
{
  event_type: 'purchase',
  
  // Conversion data
  value: 99.99,
  currency: 'USD',
  order_id: 'ORDER-12345',
  
  // Attribution (from stored click history)
  gclid: 'Cj0KCQjw...',
  
  // User data for Enhanced Conversions (hashed)
  user_data: {
    email: 'hashed_email',
    phone: 'hashed_phone'
  }
}
```

Convultra then:
1. Validates and deduplicates the event
2. Enriches with any additional stored data
3. Formats for each connected ad platform
4. Forwards via server-side APIs

**Example: Google Ads format:**
```javascript
{
  conversionAction: 'customers/123/conversionActions/456',
  gclid: 'Cj0KCQjw...',
  conversionDateTime: '2024-01-15 12:30:45-05:00',
  conversionValue: 99.99,
  currencyCode: 'USD',
  orderId: 'ORDER-12345',
  userIdentifiers: [
    { hashedEmail: 'sha256_hash' },
    { hashedPhoneNumber: 'sha256_hash' }
  ]
}
```

**Example: Meta Conversions API format:**
```javascript
{
  event_name: 'Purchase',
  event_time: 1704067200,
  action_source: 'website',
  user_data: {
    em: ['sha256_email_hash'],
    ph: ['sha256_phone_hash'],
    fbc: 'fb.1.1704067200.IwAR3x...',
    fbp: 'fb.1.1704067200.abc123'
  },
  custom_data: {
    value: 99.99,
    currency: 'USD',
    order_id: 'ORDER-12345'
  }
}
```

---

## Phase 4: Recover

Convultra tracks which conversions would have been lost by traditional tracking:

### Recovery Classification

A conversion is marked as "recovered" when:

| Condition | Why It Would Be Lost |
|-----------|---------------------|
| **iOS Safari + click age > 7 days** | Safari ITP deletes cookies after 7 days |
| **Click age > 30 days** | Standard cookies expire |
| **Platform cookie missing** | User cleared cookies or uses private browsing |
| **Ad blocker detected** | Platform pixel was blocked |

### What You See in Dashboard

- **Recovery Rate** - Percentage of conversions that would have been lost
- **Tracking Uplift** - How much more you're tracking vs. platform pixels alone
- **Recovered Revenue** - Total value of recovered conversions

---

## Deduplication

Convultra prevents duplicate conversions through a multi-tier system:

```
Priority 1: Conversion ID (24-hour window)
├── orderId, leadId, signupId, subscriptionId
└── Same ID = duplicate blocked

Priority 2: Click ID + Value (1-hour window)
├── gclid/fbclid/msclkid + event_type + value
└── Same combination = duplicate blocked

Priority 3: Event ID (5-minute window)
├── SDK-generated unique event ID
└── Same ID = duplicate blocked (page refresh protection)
```

---

## Data Flow Summary

```
User clicks ad → Landing page with gclid
        │
        ▼
SDK captures & stores click ID (localStorage, 90 days)
        │
        ▼
User browses site → Page views tracked
        │
        ▼
User converts → SDK sends conversion with click history
        │
        ▼
Convultra processes → Dedup → Recovery classification
        │
        ▼
Forwarded to ad platforms → Google Ads, Meta, Microsoft, TikTok
        │
        ▼
Dashboard updates → Analytics, conversions, recovery stats
```

---

## Performance

| Metric | Value |
|--------|-------|
| **SDK Size** | Under 15KB gzipped |
| **Page Load Impact** | Under 50ms |
| **Tracking Latency** | Under 200ms |
| **Platform Forwarding** | Under 5 minutes |
| **Dashboard Updates** | Real-time |

---

## Next Steps

- [SDK Configuration →](/sdk/configuration)
- [Deduplication Details →](/advanced/deduplication)
- [Attribution Models →](/advanced/attribution-models)
